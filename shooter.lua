-- title:  game title
-- author: game developer
-- desc:   short description
-- script: lua

t=0
m={}
l=0
m[l]={}
m[l].x=0
m[l].y=0
m[l].sx=10
m[l].sy=102
l=1
m[l]={}
m[l].x=30
m[l].y=0
m[l].sx=10
m[l].sy=102
l=2
m[l]={}
m[l].x=60
m[l].y=0
m[l].sx=10
m[l].sy=102
l=0

objs={}
objs.n=0
pl={}
pl.en=true
pl.x=m[l].sx
pl.y=m[l].sy
pl.vx=0
pl.vy=0
pl.i=0
pl.f=0
pl.s=1
pl.shot=0
objs[0]=pl
objs.n=1

buls_si=objs.n
buls_ei=objs.n+10
for i=buls_si,buls_ei-1 do
 objs[i]={}
 objs[i].en=false
end
objs.n=objs.n+10

enem_si=objs.n
enem_ei=objs.n+10
for i=enem_si,enem_ei-1 do
 objs[i]={}
	objs[i].en=false
end
objs.n=objs.n+10

ay=1
d=4

solids={[17]=true,[18]=true,[19]=true}

function lmget(x,y)
 return mget(x+m[l].x,y+m[l].y)
end

function door(x,y)
 return lmget(x//8,y//8)==33
end

function enemy(x,y)
 for i=enem_si,enem_ei-1 do
	 if objs[i].en
		 and objs[i].x>=x and objs[i].x<x+8
			and objs[i].y>=y and objs[i].y<y+8 then
		  return true
		end
	end
	
	return false
end

function hazard(x,y)
 return lmget(x//8,y//8)==49
end

function solid(x,y)
	return solids[lmget(x//8,y//8)]
end

function floor_below(x,y)
 return solid(x,y+8) or solid(x+7,y+8)
end

function obstacle_right(x,y)
 return solid(x+8,y) or solid(x+8,y+7)
end

function obstacle_left(x,y)
 return solid(x-1,y) or solid(x-1,y+7)
end

function walk(o)
 d=d-1
	if (d<0) then
		d=6
		o.i=o.i+1
	end
end

function try_walk(x,y,d)
 if d<0 and obstacle_left(x,y)~=true then
	 return x+d
	end
	
	if d>0 and obstacle_right(x,y)~=true then
	 return x+d
	end
	
	return x
end

function TIC()

	cls(0)
	map(m[l].x,m[l].y)
	
	if floor_below(pl.x, pl.y) then
	 if pl.vy>0 then
	  pl.vy=0
		elseif pl.vy==0 and btn(0) then
		 pl.vy=-5
		end
	else
	 while (floor_below(pl.x, pl.y+pl.vy)) do
		 pl.vy=pl.vy//2
		end
	 pl.vy=pl.vy+ay
	end

 for i=0,objs.n-1 do
	 if objs[i].en then
	  objs[i].x=objs[i].x+objs[i].vx
   objs[i].y=objs[i].y+objs[i].vy
		end
	end
	
	for i=buls_si,buls_ei-1 do
	 if objs[i].en then
			if solid(objs[i].x,objs[i].y) then
			 objs[i].en=false
			elseif objs[i].x<0 or objs[i].x>240 then
			 objs[i].en=false
			end
		end
	end

 if not objs[enem_si].en then
	 enem={}
  enem.x=80
		enem.y=112
		enem.f=0
		enem.i=0
		enem.vx=1
		enem.vy=0
		enem.s=65
		objs[enem_si]=enem
		objs[enem_si].en=true
	else
	 if enem.f==0 and obstacle_right(enem.x,enem.y) then
		  enem.vx=-1
				enem.f=1
		elseif obstacle_left(enem.x,enem.y) then
		  enem.vx=1
				enem.f=0
		end
		walk(enem)
	end

 if door(pl.x,pl.y) then
	 print("Open, says me!")
		pl.x=10
	 l=l+1
	elseif hazard(pl.x,pl.y) or enemy(pl.x,pl.y) then
	 print("Ooops, you die!")
		pl.x=m[l].sx
		pl.y=m[l].sy
	end
	
	if btn(3) then
	 pl.x=try_walk(pl.x,pl.y,1)
		pl.f=0
		walk(pl)
	end
	
	if btn(2) then
	 pl.x=try_walk(pl.x,pl.y,-1)
		pl.f=1
		walk(pl)
	end
	
	if btn(4) and t-pl.shot>8 then
	 bul={}
		bul.vy=0
		bul.s=0
		if pl.f==1 then
		 bul.x=pl.x-1
			bul.vx=-2
		else
	  bul.x=pl.x+8
			bul.vx=2
		end
	 bul.y=pl.y+4
		for i=buls_si,buls_ei-1 do
		 if not objs[i].en then
			 objs[i]=bul
				objs[i].en=true
  	 pl.shot=t
  		rect(bul.x,bul.y,1,1,15)
				break		
			end
		end
	end
	
	for i=0,objs.n-1 do
	 if objs[i].en then
	  if objs[i].s == 0 then
		  rect(objs[i].x,objs[i].y,1,1,15)
		 else
    spr(objs[i].s+objs[i].i%3,objs[i].x,objs[i].y,0,1,objs[i].f,0,1,1)
		 end
		end
	end
	t=t+1
end

-- <TILES>
-- 001:00011000001111000009d00000099000001111aa004111400001110000060600
-- 002:00011000001111000009d00000099000001111aa004111400001110000600600
-- 003:00011000001111000009d00000099000001111aa004111400001110000066000
-- 017:5555555545454545444444444444444444474444444444444744474444444444
-- 018:4444444444444444444447444444444444444444474444444444447444444444
-- 019:9999999911119911999911999999999900000000000000000000000000000000
-- 033:01111110010000100100001001911910019119f0019119100191191001911910
-- 049:8888888888888888888888888888888888888888888888888888888888888888
-- 064:0000000000000000000000000000000000000000000000000000000066666666
-- 065:0000000000000000000000000000200000055555055550f00505000000000000
-- 066:000000000000000000000000000020000005555505555f0f0055000000000000
-- 067:000000000000000000000000000020000005555505555ff00500500000000000
-- </TILES>

-- <MAP>
-- 000:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:210000000000000000000000000000000000000000000021212121212121210000000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:210000000000000000000000000000000000000000000021212121212121210100000000000000000000000000000000000000000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:210000000000000000000000000000000000000000000021212121212121210100000000000000000000000000000000313131000000000000000021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:210000000000000000000000000000000000000012000021212121212121210100000000000000000031000031313100000000000000000000000121210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:210000000000000000000000003131313100001111111121212121212121210100000000000000003100000000000000000000000000000000120021210000000000000000000000000000000000000000000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:210000000000000031313131000000000000002121212121212121212121210100000000313131310000000000000000000000111111111111111121210000000000003131310000000000000000003131003100000012000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:210000000011110000000004000000000000002121212121212121212121210100000031000000000000000000000000000000212121212121212121211111111111131313131311111111111111131313131313111111111121000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:211111111121211111111111111111111111112121212121212121212121211111111111131313131313131313131313131313212121212121212121212121212121212121212121212121212121212121212121212121212121000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:212121212121212121212121212121212121212121212121212121212121212121212121131313131313131313131313131313212121212121212121212121212121212121212121212121212121212121212121212121212121000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 017:000000000000000000000000000000000000000000000000000000000000000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:10101010000000000000000000000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:140c1c44243430346d4e4a4e854c30346524d04648757161597dced27d2c8595a16daa2cd2aa996dc2cadad45edeeed6
-- </PALETTE>

